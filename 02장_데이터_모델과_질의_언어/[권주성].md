# 02. 데이터 모델과 질의 언어
- 데이터 모델은 소프트 웨어 개발에서 제일 중요한 부분 중 하나
- 데이터 모델은 `해결하려는 문제를 어떻게 생각해야 하는지`에 대해서도 영향을 줌
- 대부분의 애플리케이션 데이터 모델은 계층적으로 만들어짐
  - **`데이터 모델의 표현법`**

    - 현실과 대응대는 개념적 모델(객체 지향, 도메인, 등)
    - 범용 데이터 모델(JSON, 테이블, 그래프, 등)
    - 바이트 단위의 모델(메모리, 디스크, 네트워크에서 사용되는 프로토콜)
    - 하드웨어 측면의 데이터 표현(전류, 빛의 파동, 등)

  - 각 계층은 명확한 데이터 모델을 제공해 하위 계층의 복잡성을 숨김
    - 이러한 추상화는 각 계층의 벤더사의 의존적이지 않고, 효율적으로 일할 수 있게 해줌

  - 적합한 데이터 모델을 선택하는 작업은 상당히 중요하고 어려움
    - 각각의 특징과 장단점. 적합한 상황과 원리를 이해해야함 

## 관계형(Relation) 모델과 문서(Document) 모델
### 관계형 모델
  - 오늘 날 가장 잘 알려진 데이터 모델로, 1970년 에드가 코드가 제안한 SQL 모델
  - 각 데이터는 관계(Table)로 구성되고 각 관계는 순서 없는 튜플(Row)의 모음으로 구성됨
  - 관계형 모델은 정리된 인터페이스 뒤로 구현의 세부 사항을 숨김
  - 1960 ~ 70년 대의 비즈니스 데이터 처리(트랜잭션 처리와 일괄 처리)에 주로 사용됨
  - 이후 많은 데이터 모델들(네트워크, 계층, 등)과의 경쟁에서 우위를 점하고 현재까지도 가장 널리 사용되고 있음

### NoSQL의 탄생
- NoSQL(Not Only SQL)은 2010년에 오픈 소스, 분산 환경, 비관계형 데이터베이스, 등이 주목 받으면서 등장한 개념
- 아래와 같은 시대 흐름을 만족하기 위해 등장한 여러 가지 유형의 데이터베이스들을 총칭해서 부르는 말임
  - 대규모 데이터셋이나 매우 높은 쓰기 처리량 달성을 위한 뛰어난 확장성 필요
  - 무료 오픈 소스 소프트웨어의 선호도 증가
  - 관계형 모델에서 지원하지 않는 특수 질의 동작 필요
  - 관계형 스키마의 제한에 대한 불만
  - 더욱 동적이고 표현력이 풍부한 데이터 모델에 대한 바람

  ![SQLandNoSQL](https://github.com/user-attachments/assets/98b44ace-9963-4ba9-9a53-c6cfdf215943)

- 예시로, MongoDB, Redis, DynamoDB, Kafka, 등이 있음
- 최근에는 **`다중 저장소 지속성(Polyglot Persistense)`** 환경으로 가는 추세임
  - 여러 저장소를 사용해 데이터를 지속적으로 관리하는 기술
  - 즉, 애플리케이션 마다 요구사항이 다르기 때문에 SQL(관계형) & NoSQL을 함께 사용 사례에 맞게 선택하여 적절한 곳에 활용한다는 뜻

### 객체 관계형 불일치
- 어플리케이션 개발에서 관계형 테이블을 사용하려면, 어플리케이션 코드와 데이터베이스 모델 객체 사이의 전환이 필요함
  - 이런 모델 사이의 분리를 **`임피던스 불일치(Impedance Mismatch)`** 라고 부름
  - ORM 프레임 워크가 전환에 필요한 상용구 코드(Boilerplate Code)의 양을 줄여주긴 하지만, 두 모델 간의 차이를 완벽하게 숨길 수는 없음

- 예시) 링크드인 이력서 포맷

  ![CleanShot 2025-03-23 at 04 42 15](https://github.com/user-attachments/assets/60257925-48ba-47ea-b7ee-35836c3ab52d)

  - RDBMS에서는 직위, 학력, 연락처, 등 정보를 개별 테이블로 분리후 외래키로 유저 테이블(user_id)를 참조하는 방식으로 데이터를 저장함
  - Document DB에서는 JSON 형태로 하나의 문서(Document)에 유저의 모든 정보(직위, 학력, 연락처, 등)을 포함하여 저장함
    - 다중 테이블 스키마 보다 더 나은 지역성을 가짐
    - 종종 JSON이 임피던스 불일치를 줄인다고 생각하지만, JSON도 데이터 부호화 형식으로 가지는 문제가 있음 

- 이력서와 같은 **일대다 관계는 트리와 같은 데이터 구조가 적합함**
  - 따라서, 문서형 DB에 적합함
  - 반면에, 관계형 DB의 경우에는 하나의 이력서를 조회하기 위해 여러 정보를 Join해야하기 때문에 복잡한 쿼리가 필요함  

    ![CleanShot 2025-03-23 at 04 48 08](https://github.com/user-attachments/assets/a93d8274-4bd8-43f9-a9d2-a3d25cf4a5df)

### 다대일과 다대다 관계
- 관계형은 참조(ID) 정보를 통해 중복을 줄일 수 있음
  - 데이터 중복은 단순 저장 용량의 상승 뿐 아니라 데이터 변경시 전부 변경해주어야 하는 문제가 있음
  - 즉, `데이터 중복이 많은 경우 데이터의 무결성을 유지하기 어려움`
  - 이를 해결하는 과정을 데이터 정규화라고 함

- 중복된 데이터는 보통 다대일 관계인 경우임
  - 따라서, 문서 모델은 다대일 관계에 적합하지 않음
 
- 또한, 기능의 추가가 발생하여 다대다 관계로 발전하는 경우에도 관계형 DB가 적합함 
  - 예를 들어 이력서에 들어가는 조직, 학교, 등과 같은 정보가 엔티티로서 별도로 존재해야한다면 그때 부터는 일대다 관계에서 참조되어야하는 데이터가 되고 이는 Join이 필요함
  - 어플리케이션에 기능을 추가하면서 데이터는 점차 상호 연결되는 경향이 있음

  ![CleanShot 2025-03-23 at 04 53 46](https://github.com/user-attachments/assets/57d4c5f6-57ba-4ce5-ba81-1c282adf7463)

#### 결론
- **`관계형 데이터베이스는 다대일 혹은 다대다 관계와 여러 엔티티에 대한 조인에 적합함`**
- **`문서형 데이터베이스는 일대다 관계와 같이 하나의 엔티티에 대한 데이터를 지역성있게 저장/조회하는데 적합함`**

### 문서 데이터베이스는 역사를 반복하고 있나?
- 네트워크 모델
  - 관계를 포인터와 같이 최상위 레코드로부터 연결 경로를 따름 (접근 경로)

- 관계형 모델
  - 접근 경로 없이 조회 및 삽입 가능
  - 쿼리 옵티마이저에 의해 질의 순서 및 사용 색인을 자동으로 결정 (접근 경로를 자동으로)

- 문서형 모델
  - 일대다 관계를 중첩된 레코드로 표현(트리 구조)
  - 외래 키 역할을 하는 문서 참조로 다대일, 다대다 표현 가능

### 관계형 데이터베이스와 오늘날의 문서 데이터베이스
- 문서형 DB
  - 스키마 유연성
    - 읽기 스키마
      - 쓰기 시점 필드 존재 여부를 보장하지 않음
      - 동적 타입 확인과 유사(런타임)
    - 따라서, 필드 추가시 마이그레이션이 필요하지 않음
  - 지역성으로 나은 성능
    - 한 번에 문서의 많은 부분이 필요함 → 작게 유지
  - 애플리케이션 데이터 구조와 유사
  - 다대다 관계에서 비정규화 데이터 일관성을 유지하기 위해 추가 작업 필요

- 관계형 DB
  - 샤딩으로 복잡한 애플리케이션 코드, 스키마 변경 시 마이그레이션 필요, 조회 시 다중 조인으로 많은 디스크 탐색
  - 쓰기 스키마
    - 스키마가 명시적이고 쓰여진 모든 데이터가 스키마를 따름을 보장함
    - 정적 타입 확인과 유사(컴파일 타임)
  - 새로운 필드를 추가하려면 일반적인 RDB에서는 마이그레이션(migration)을 수행해서 스키마를 변경해야함

- 이외에도 내결함성과 동시성, 등 고려해야할 차이점이 더 있음
   
### 질의를 위한 데이터 지역성
- `저장소 지역성(Storage Locality)`를 잘 살리려면 문서를 작게 유지하는 것을 권장
- 문서 모델 외에도 다중 테이블 색인 클러스터 테이블, 칼럼 패밀리 개념 등을 통해 지역성을 활용할 수 있게 제공함

### 문서 데이터베이스와 관계형 데이터베이스의 통합
- MySQL 5.7, PostgreSQL 9.3부터 JSON 문서를 지원하기 시작
- MongoDB 또한 자동으로 참조를 확인하고 JOIN 연산을 지원함
- 이렇듯, 시간이 지남에 따라 점점 서로가 비슷해지고 있음
- 이는 매우 긍정적인 현상임. 각 데이터 모델이 서로 부족한 부분을 보완해 나가고 있기 때문에
- 미래 데이터베이스는 관계형과 문서형의 혼합 모델로 나아가야함

## 데이터를 위한 질의 언어
- SQL은 선언형 질의 언어
  - 목표를 달성하기 위한 방법이 아닌 알고자 하는 데이터의 패턴, 즉 결과가 충족해야 하는 조건과 데이터를 어떻게 반환할지를 지정함
  - 방법은 시스템의 구현에서 결정함(즉, 내부적으로 최적화가 수행됨)
  - 병렬 실행에 적합함

- 이시기에 등장한 다른 언어인 ISM, 코다실은 명령형 질의 언어
  - 명령형은 특정 순서로 특정 연산을 수행하게끔 컴퓨터에게 지시를 내림

 ### 웹에서의 선언형 질의
- 웹 브라우저에서 선언형 CSS 스타일을 사용하는 편이 자바스크립트에서 명령형으로 스타일을 다루기보다 훨씬 나음
- 마찬가지로 데이터베이스에서는 SQL 같은 선언형 질의 언어가 명령형 질의 API 보다 훨씬 좋음

### 맵리듀스(MapReduce) 질의
- 맵리듀스는, **`많은 컴퓨터에서 대량의 데이터를 처리하기 위한 프로그래밍 모델`** 로, 구글에 의해 널리 알려짐
  - 선언형과 명령형 그 중간에 있는 형태
  - 질의 로직은 처리 프레임워크가 반복적으로 호출하는 조각 코드로 표현함
  - 함수형의 Map(collect)와 Reduce(fold/inject) 함수를 기반으로 함

 - 예시
   - PostgreSQL에서 데이터 조회 

    ![CleanShot 2025-03-23 at 05 11 37](https://github.com/user-attachments/assets/af4b050b-2c64-4076-8c9c-6ff616cb0ab9)

  - MongoDB 의 MapReduce 사용

    ![CleanShot 2025-03-23 at 05 15 03](https://github.com/user-attachments/assets/dbbc0bf2-8bfc-4ec0-a9c6-819cfda28c13)

    ![CleanShot 2025-03-23 at 05 15 51](https://github.com/user-attachments/assets/5077b0c0-5fe7-4e05-af0d-c1970f80ee6d)

- 클러스터 환경에서 분산 실행을 위한 프로그래밍 모델인 맵리듀스는 상당히 저수준 프로그래밍 모델임
  - 맵리듀스를 사용하지 않는 분산 SQL 구현도 있음
 
- 참고로, MongoDB에서는 집계 파이프라인  이라 부르는 선언형 질의 언어 지원을 추가함

    ![CleanShot 2025-03-23 at 05 06 03](https://github.com/user-attachments/assets/677471da-1684-46d6-a938-c5188be2b5db)

  - 반대로, PostgreSQL은 JSON 데이터 타입을 지원함

- NoSQL과 SQL이 유사해지고 있음

## 그래프형 데이터 모델
- 데이터 간 연결이 복잡해지거나, 다대다 관계가 많아지는 경우 그래프형 데이터 모델이 데이터간의 관계를 표현하기 더 적절함
- 그래프형 데이터 모델은 정점과 간선으로 두가지 유형의 객체로 이루어진 데이터 모델
  - `정점(vertex)` = 노드(node)나 엔티티(entity)
  - `간선(edge)` = 관계(relation)나 호(arc)

- 예를 들어, 소셜 그래프, 웹 그래프, 도로나 철도 네트워크, 등을 표현하기에 적합함

  ![CleanShot 2025-03-30 at 03 40 10](https://github.com/user-attachments/assets/6ea7806f-4fd0-4c8c-b361-a31577a42a37)

- 그래프에서 데이터를 구조화하고 질의하는 여러가지 방법이 있음
  - 속성 그래프, 트리플 저장소 모델, 등

### 속성 그래프
- 정점의 구성 
  - 고유한식별자
  - 유출(outgoing) 간선 집합
  - 유입(incoming) 간선 집합
  - 속성 컬렉션(키—값 쌍)

- 간선의 구성
  - 고유한식별자
  - 간선이 시작하는 정점(꼬리 정점)
  - 간선이 끝나는 정점(머리 정점)
  - 두 정점 간 관계 유형을 설명하는 레이블
  - 속성 컬렉션(키—값 쌍)

- 특징
  - 정점은 다른 정점과 간선으로 연결됨
  - 정점이 주어지면 정점의 유입과 유출 간선을 효율적으로 찾을 수 있고, 그래프를 순회할 수 있음
  - 다른 유형의 관계에 서로 다른 레이블을 사용하면 단일 그래프에 다른 유형의 정보를 저장하면서도 데이터 모델을 깔끔하게 유지 가능

- 그래프는 발전성이 좋아서 어플리케이션에 기능을 추가하는 경우 어플리케이션의 데이터 구조 변경을 수용하게끔 그래프를 쉽게 확장 가능함

### 사이퍼 질의 언어
- 속성 그래프를 위한 선언형 질의 언어
  - 질의의 다른 부분에서 이름을 사용해 정점간 간선을 화살표 표기를 사용해 만들 수 있음

- 질의 최적화기가 가장 효율적이라고 예측한 전략을 자동으로 선택하므로 수행에 대해 자세히 지정할 필요 없음

### SQL의 그래프 질의
- 그래프 데이터를 관계형 구조로 넣어도 SQL을 사용해 질의할 수 있을까?
  - 대답은 예 이지만 복잡하고 어려움 
- 재귀 공통 테이블 식(WITH RECURSIVE 문)을 이용해 가변 순회 경로 질의는 가능함
- 이를 통해 알 수 있는 것은 다양한 데이터 모델이 서로 다른 사용 사례를 만족하기 위해 설계되었다는 것
- 따라서, 애플리케이션에 적합한 데이터 모델을 선택하는 작업은 매우 중요함

### 트리플 저장소와 스파클
- 모든 정보를 주어, 서술어, 목적어처럼 매 우 간단한 세 부분 구문 형식으로 저장

### 스파클 질의 언어
- RDF 데이터 모델을 사용한 트리플 저장소 질의 언어

### 데이터로그
- 데이터 로그의 데이터 모델은 트리플 저장소 모델과 유사하지만 조금 더 일반화된 형태
  - (주어, 서술어, 목적어)로 트리플을 작성하는 대신 서술어(주어, 목적어)로 작성

## 정리
- 애플리케이션 요구 사항에 가장 적합한 모델을 찾는 것이 매우 중요함

- 역사적으로 초창기에는 데이터를 계층 구조(하나의 큰 트리 형태)로 표현하려고 했지만 다대다 관계를 표현하기에 적절하지 않았음
  - 이를 해결하기 위해 관계형 모델이 고안됨

- 최근에는 비관계형 데이터 저장소로써 NoSQL이 대두됨
  - 문서 데이터베이스 : 데이터가 문서 자체에 포함돼 있으면서 하나의 문서와 다른 문서 간 관계가 거의 없는 사용 사례를 대상으로 함
  - 그래프 데이터베이스 : 문서 데이터베이스와는 정반대로 모든 것이 잠재적으로 관련 있다는 사용 사례를 대상으로 함

- 문서 및 그래프 데이터베이스의 공통점 중 하나는 일반적으로 저장할 데이터를 위한 스키마를 강제하지 않아 변화하는 요구사항에 맞춰 애플리케이션을 쉽게 변경할 수 있다는 점
- 하지만 애플리케이션은 데이터가 특정 구조를 갖는다고 가정할 가능성이 높으며, 이는 스키마가 명시적인지(쓰기에 강요됨) 암시적인지(읽기에 다뤄짐)의 문제일 뿐

- 각 데이터 모델은 고유한 질의 언어 및 프레임워크를 제공함

- 한 모델을 다른 모델로 흉내는 낼 수 있으나 그 결과는 대부분 엉망임.
  - 이것이 바로 단일 만능 솔루션이 아닌 각기 목적에 맞는 다양한 시스템을 보유해야하는 이유임
